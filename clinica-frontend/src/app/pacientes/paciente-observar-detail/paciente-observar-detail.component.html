<div class="observar-detail-container">

  @if (errorCarga) {
    <div style="padding: 0 20px;">
      <mat-card class="mat-error-card" style="background-color: #fdecea; color: #a04446; padding: 15px;">
        <mat-card-content>{{ errorCarga }}</mat-card-content>
      </mat-card>
    </div>
  } @else if (paciente$ | async; as paciente) {
     @if (paciente) {
      <mat-sidenav-container class="sidenav-container">

        <mat-sidenav mode="side" opened class="sidenav-panel" style="width: 240px; border-right: 1px solid rgba(0,0,0,.12); background: #f5f5f5;">
          <h3 style="padding: 15px 16px; margin: 0; border-bottom: 1px solid rgba(0,0,0,.1);">Secciones Paciente</h3>
          <mat-nav-list>
             <a mat-list-item [class.active-link]="seccionActiva === 'datos-personales'" (click)="cambiarSeccion('datos-personales')">
              <mat-icon matListItemIcon>person_outline</mat-icon>
              <span matListItemTitle>Datos Personales</span>
            </a>
            <a mat-list-item [class.active-link]="seccionActiva === 'alergias'" (click)="cambiarSeccion('alergias')">
              <mat-icon matListItemIcon>sick</mat-icon>
              <span matListItemTitle>Alergias y Transf.</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'antecedentes'" (click)="cambiarSeccion('antecedentes')">
              <mat-icon matListItemIcon>assignment</mat-icon>
              <span matListItemTitle>Antecedentes</span>
            </a>
            <a mat-list-item [class.active-link]="seccionActiva === 'medicacion'" (click)="cambiarSeccion('medicacion')">
              <mat-icon matListItemIcon>medication</mat-icon>
              <span matListItemTitle>Medicación</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'historia'" (click)="cambiarSeccion('historia')">
              <mat-icon matListItemIcon>history</mat-icon>
              <span matListItemTitle>Historia Clínica</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'dialisis'" (click)="cambiarSeccion('dialisis')">
              <mat-icon matListItemIcon>monitor_heart</mat-icon>
              <span matListItemTitle>Parám. Diálisis</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'evolucion'" (click)="cambiarSeccion('evolucion')">
              <mat-icon matListItemIcon>assessment</mat-icon>
              <span matListItemTitle>Evolución Mensual</span>
            </a>
            <a mat-list-item [class.active-link]="seccionActiva === 'qr'" (click)="cambiarSeccion('qr')">
              <mat-icon matListItemIcon>qr_code</mat-icon>
              <span matListItemTitle>Código QR</span>
            </a>
            </mat-nav-list>
        </mat-sidenav>

        <mat-sidenav-content class="content-panel" style="background-color: white;">
          <div style="padding: 20px 20px 0 20px;">
             <h2 style="margin: 0;">{{ paciente.nombre }} {{ paciente.apellido }}</h2>
             <p style="color: grey; margin-top: 5px;">ID: {{ paciente.id }} | Documento: {{ paciente.documento }}</p>
             <mat-divider style="margin-top: 15px;"></mat-divider>
          </div>

          <div style="padding: 20px;">
            <!-- Mostrar contenido basado en la sección activa -->
            @if (seccionActiva === 'datos-personales') {
              <div class="seccion-content">
                <h3>Datos Personales</h3>
                <div class="datos-grid">
                  <div><strong>Nombre:</strong> {{ paciente.nombre }}</div>
                  <div><strong>Apellido:</strong> {{ paciente.apellido }}</div>
                  <div><strong>Documento:</strong> {{ paciente.documento }}</div>
                  <div><strong>Fecha de Nacimiento:</strong> {{ paciente.fechaNacimiento | date:'dd/MM/yyyy' }}</div>
                  <div><strong>Género:</strong> {{ paciente.genero }}</div>
                  <div><strong>Estado Civil:</strong> {{ paciente.estadoCivil }}</div>
                  <div><strong>Fecha Primera Diálisis:</strong> {{ paciente.fechaPrimeraDialisis | date:'dd/MM/yyyy' }}</div>
                  <div><strong>Teléfonos:</strong> {{ paciente.telefonos?.join(', ') || 'No especificado' }}</div>
                  <div><strong>Emails:</strong> {{ paciente.emails?.join(', ') || 'No especificado' }}</div>
                  <div><strong>Domicilio:</strong> {{ paciente.domicilio || 'No especificado' }}</div>
                  <div><strong>Obra Social:</strong> {{ paciente.obraSocial || 'No especificado' }}</div>
                  <div><strong>Institución:</strong> {{ paciente.institucion || 'No especificado' }}</div>
                </div>
              </div>
            } @else if (seccionActiva === 'alergias') {
              <div class="seccion-content">
                <h3>Alergias y Transfusiones</h3>
                <div class="datos-grid">
                  <div><strong>Alergias:</strong></div>
                  <div *ngIf="paciente.alergias && paciente.alergias.length > 0">
                    <ul>
                      <li *ngFor="let alergia of paciente.alergias">{{ alergia.descripcion }}</li>
                    </ul>
                  </div>
                  <div *ngIf="!paciente.alergias || paciente.alergias.length === 0">No hay alergias registradas</div>
                  <div><strong>Testigo de Jehová:</strong> {{ paciente.testigoJehova ? 'Sí' : 'No' }}</div>
                  <div><strong>Se Transfunde:</strong> {{ paciente.seTransfunde ? 'Sí' : 'No' }}</div>
                </div>
              </div>
            } @else if (seccionActiva === 'antecedentes') {
              <div class="seccion-content">
                <h3>Antecedentes Personales</h3>
                <div *ngIf="paciente.antecedentesPersonales && paciente.antecedentesPersonales.length > 0">
                  <ul>
                    <li *ngFor="let antecedente of paciente.antecedentesPersonales">{{ antecedente.nombre }} - {{ antecedente.detalle }}</li>
                  </ul>
                </div>
                <div *ngIf="!paciente.antecedentesPersonales || paciente.antecedentesPersonales.length === 0">
                  No hay antecedentes personales registrados
                </div>
              </div>
            } @else if (seccionActiva === 'medicacion') {
              <div class="seccion-content">
                <h3>Medicación Actual</h3>
                <div *ngIf="paciente.medicacionActual && paciente.medicacionActual.length > 0">
                  <ul>
                    <li *ngFor="let med of paciente.medicacionActual">{{ med.nombre }} - {{ med.dosis }}</li>
                  </ul>
                </div>
                <div *ngIf="!paciente.medicacionActual || paciente.medicacionActual.length === 0">
                  No hay medicación registrada
                </div>
              </div>
            } @else if (seccionActiva === 'historia') {
              <div class="seccion-content">
                <h3>Historia Clínica</h3>
                <div *ngIf="paciente.historiaClinica && paciente.historiaClinica.length > 0">
                  <div *ngFor="let historia of paciente.historiaClinica" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <strong>{{ historia.fecha }}:</strong> {{ historia.detalle }}
                  </div>
                </div>
                <div *ngIf="!paciente.historiaClinica || paciente.historiaClinica.length === 0">
                  No hay historia clínica registrada
                </div>
              </div>
            } @else if (seccionActiva === 'dialisis') {
              <div class="seccion-content">
                <h3>Parámetros de Diálisis</h3>
                <div *ngIf="paciente.parametrosDialisis && objectKeys(paciente.parametrosDialisis).length > 0">
                  <div class="datos-grid">
                    <div *ngFor="let key of objectKeys(paciente.parametrosDialisis)">
                      <strong>{{ key }}:</strong> {{ paciente.parametrosDialisis[key] }}
                    </div>
                  </div>
                </div>
                <div *ngIf="!paciente.parametrosDialisis || objectKeys(paciente.parametrosDialisis).length === 0">
                  No hay parámetros de diálisis registrados
                </div>
              </div>
            } @else if (seccionActiva === 'evolucion') {
              <div class="seccion-content">
                <h3>Evolución Mensual</h3>
                <div *ngIf="paciente.evolucionMensual && paciente.evolucionMensual.length > 0">
                  <div *ngFor="let evolucion of paciente.evolucionMensual" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <strong>{{ evolucion.mes }}:</strong>
                    <div style="margin-left: 20px;">
                      {{ evolucion.detalle }}
                    </div>
                  </div>
                </div>
                <div *ngIf="!paciente.evolucionMensual || paciente.evolucionMensual.length === 0">
                  No hay evolución mensual registrada
                </div>
              </div>
            } @else if (seccionActiva === 'qr') {
              <div class="seccion-content">
                <h3>Código QR del Paciente</h3>
                <p>El código QR permite el acceso seguro a la información del paciente.</p>
                <div style="text-align: center; margin: 20px 0;">
                  <img [src]="'http://localhost:8080/api/qr/' + paciente.id" alt="Código QR" style="max-width: 200px; border: 1px solid #ccc; padding: 10px;">
                </div>
                <div style="text-align: center;">
                  <button mat-raised-button color="primary" (click)="descargarQr()">
                    <mat-icon>download</mat-icon> Descargar QR
                  </button>
                </div>
                <p style="font-size: 14px; color: #666; margin-top: 20px;">
                  <strong>Nota:</strong> El QR se genera automáticamente al crear el paciente y se envía a los emails prioritarios configurados.
                  Si se modifican los emails prioritarios, el QR se reenviará automáticamente.
                </p>
              </div>
            }
          </div>

        </mat-sidenav-content>

      </mat-sidenav-container>
     } @else {
        <p style="padding: 20px;">No se encontraron datos para este paciente.</p>
     }
  } @else {
    <div style="text-align: center; padding: 40px;"> <p>Cargando datos del paciente...</p> </div>
  }
</div>
