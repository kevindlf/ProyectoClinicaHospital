<div class="detail-container">
  <button mat-stroked-button class="back-button" (click)="volver()">
    <mat-icon>arrow_back</mat-icon> Volver a la Lista de Pacientes
  </button>
  @if (errorCarga) {
    <div class="error-card">
      <mat-card class="mat-error-card">
        <mat-card-content>{{ errorCarga }}</mat-card-content>
      </mat-card>
    </div>
  } @else if (paciente$ | async; as paciente) {
     @if (paciente) {
      <mat-sidenav-container class="sidenav-container">

        <!-- 游댳 Sidenav lateral -->
        <mat-sidenav
          #sidenav
          class="sidenav-panel"
          [mode]="window.innerWidth > 900 ? 'side' : 'over'"
          [opened]="window.innerWidth > 900"
        >
          <div class="sidenav-header">
            <h3>Secciones del Paciente</h3>
            <button
              mat-icon-button
              class="toggle-btn"
              (click)="cerrarSidenav()"
              aria-label="Cerrar men칰"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
          
          <mat-nav-list>
             <a mat-list-item [class.active-link]="seccionActiva === 'datos-personales'" (click)="cambiarSeccion('datos-personales')">
              <mat-icon matListItemIcon>person_outline</mat-icon>
              <span matListItemTitle>Datos Personales</span>
            </a>
            <a mat-list-item [class.active-link]="seccionActiva === 'alergias'" (click)="cambiarSeccion('alergias')">
              <mat-icon matListItemIcon>sick</mat-icon>
              <span matListItemTitle>Alergias y Transf.</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'antecedentes'" (click)="cambiarSeccion('antecedentes')">
              <mat-icon matListItemIcon>assignment</mat-icon>
              <span matListItemTitle>Antecedentes</span>
            </a>
            <a mat-list-item [class.active-link]="seccionActiva === 'medicacion'" (click)="cambiarSeccion('medicacion')">
              <mat-icon matListItemIcon>medication</mat-icon>
              <span matListItemTitle>Medicaci칩n</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'historia'" (click)="cambiarSeccion('historia')">
              <mat-icon matListItemIcon>history</mat-icon>
              <span matListItemTitle>Historia Cl칤nica</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'dialisis'" (click)="cambiarSeccion('dialisis')">
              <mat-icon matListItemIcon>monitor_heart</mat-icon>
              <span matListItemTitle>Par치m. Di치lisis</span>
            </a>
             <a mat-list-item [class.active-link]="seccionActiva === 'evolucion'" (click)="cambiarSeccion('evolucion')">
              <mat-icon matListItemIcon>assessment</mat-icon>
              <span matListItemTitle>Evoluci칩n Mensual</span>
            </a>
            </mat-nav-list>
        </mat-sidenav>

        <!-- 游댳 Contenido principal -->
        <mat-sidenav-content class="content-panel">

          <!-- Header visible solo en m칩vil -->
          <div class="sidenav-mobile-header" *ngIf="window.innerWidth <= 900">
            <button
              mat-icon-button
              (click)="abrirSidenav()"
              aria-label="Abrir men칰"
            >
              <mat-icon>menu</mat-icon>
            </button>
            <h3>Secciones del Paciente</h3>
          </div>

          <!-- Bot칩n para abrir sidenav en desktop cuando est치 cerrado -->
          <div class="sidenav-desktop-toggle" *ngIf="window.innerWidth > 900 && !sidenav.opened">
            <button
              mat-icon-button
              (click)="abrirSidenav()"
              aria-label="Abrir men칰"
            >
              <mat-icon>menu</mat-icon>
            </button>
          </div>

          <div class="patient-header">
            <h2>{{ paciente.nombre }} {{ paciente.apellido }}</h2>
            <p>ID: {{ paciente.id }} | Documento: {{ paciente.documento }}</p>
          </div>

          <div class="patient-content">
            <!-- Mostrar contenido basado en la secci칩n activa -->
            @if (seccionActiva === 'datos-personales') {
              <div class="seccion-content">
                <h3>Datos Personales</h3>
                <div class="datos-grid">
                  <div><strong>Nombre:</strong> {{ paciente.nombre }}</div>
                  <div><strong>Apellido:</strong> {{ paciente.apellido }}</div>
                  <div><strong>Documento:</strong> {{ paciente.documento }}</div>
                  <div><strong>Fecha de Nacimiento:</strong> {{ paciente.fechaNacimiento | date:'dd/MM/yyyy' }}</div>
                  <div><strong>G칠nero:</strong> {{ paciente.genero }}</div>
                  <div><strong>Estado Civil:</strong> {{ paciente.estadoCivil }}</div>
                  <div><strong>Fecha Primera Di치lisis:</strong> {{ paciente.fechaPrimeraDialisis | date:'dd/MM/yyyy' }}</div>
                  <div><strong>Tel칠fonos:</strong> {{ paciente.telefonos?.join(', ') || 'No especificado' }}</div>
                  <div><strong>Emails:</strong> {{ paciente.emails?.join(', ') || 'No especificado' }}</div>
                  <div><strong>Domicilio:</strong> {{ paciente.domicilio || 'No especificado' }}</div>
                  <div><strong>Obra Social:</strong> {{ paciente.obraSocial || 'No especificado' }}</div>
                  <div><strong>Instituci칩n:</strong> {{ paciente.institucion || 'No especificado' }}</div>
                </div>
              </div>
            } @else if (seccionActiva === 'alergias') {
              <div class="seccion-content seccion-alergias">
                <h3>Alergias y Transfusiones</h3>
                <div class="datos-grid">
                  <div><strong>Alergias:</strong></div>
                  <div *ngIf="paciente.alergias && paciente.alergias.length > 0">
                    <ul>
                      <li *ngFor="let alergia of paciente.alergias">{{ alergia.descripcion }}</li>
                    </ul>
                  </div>
                  <div *ngIf="!paciente.alergias || paciente.alergias.length === 0">No hay alergias registradas</div>
                  <div><strong>Testigo de Jehov치:</strong> {{ paciente.testigoJehova ? 'S칤' : 'No' }}</div>
                  <div><strong>Se Transfunde:</strong> {{ paciente.seTransfunde ? 'S칤' : 'No' }}</div>
                </div>
              </div>
            } @else if (seccionActiva === 'antecedentes') {
              <div class="seccion-content seccion-antecedentes">
                <h3>Antecedentes Personales</h3>
                <div *ngIf="paciente.antecedentesPersonales && paciente.antecedentesPersonales.length > 0">
                  <ul>
                    <li *ngFor="let antecedente of paciente.antecedentesPersonales">{{ antecedente.nombre }} - {{ antecedente.detalle }}</li>
                  </ul>
                </div>
                <div *ngIf="!paciente.antecedentesPersonales || paciente.antecedentesPersonales.length === 0">
                  No hay antecedentes personales registrados
                </div>
              </div>
            } @else if (seccionActiva === 'medicacion') {
              <div class="seccion-content seccion-medicacion">
                <h3>Medicaci칩n Actual</h3>
                <div *ngIf="paciente.medicacionActual && paciente.medicacionActual.length > 0">
                  <ul>
                    <li *ngFor="let med of paciente.medicacionActual">{{ med.nombre }} - {{ med.dosis }}</li>
                  </ul>
                </div>
                <div *ngIf="!paciente.medicacionActual || paciente.medicacionActual.length === 0">
                  No hay medicaci칩n registrada
                </div>
              </div>
            } @else if (seccionActiva === 'historia') {
              <div class="seccion-content">
                <h3>Historia Cl칤nica</h3>
                <div *ngIf="paciente.historiaClinica && paciente.historiaClinica.length > 0">
                  <div *ngFor="let historia of paciente.historiaClinica" style="margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <div class="historia-header">
                      <div><strong>Fecha:</strong> {{ historia.fecha }}</div>
                      <div *ngIf="historia.profesional"><strong>Profesional:</strong> {{ historia.profesional }}</div>
                    </div>
                    <div class="datos-grid">
                      <div *ngIf="historia.grupoSanguineo"><strong>Grupo Sangu칤neo:</strong> {{ historia.grupoSanguineo }}</div>
                      <div *ngIf="historia.peso"><strong>Peso:</strong> {{ historia.peso }} kg</div>
                      <div *ngIf="historia.pesoSeco"><strong>Peso Seco:</strong> {{ historia.pesoSeco }} kg</div>
                      <div *ngIf="historia.altura"><strong>Altura:</strong> {{ historia.altura }} cm</div>
                      <div *ngIf="historia.fechaPrimeraDialisisVida"><strong>Fecha Primera Di치lisis Vida:</strong> {{ historia.fechaPrimeraDialisisVida }}</div>
                      <div *ngIf="historia.fechaPrimeraDialisisClinica"><strong>Fecha Primera Di치lisis Cl칤nica:</strong> {{ historia.fechaPrimeraDialisisClinica }}</div>
                      <div *ngIf="historia.heparina"><strong>Heparina:</strong> {{ historia.heparina }}</div>
                      <div *ngIf="historia.antecedentesEnfermedad"><strong>Antecedentes Enfermedad:</strong> {{ historia.antecedentesEnfermedad }}</div>
                      <div *ngIf="historia.medicacionPrescritaDialisis"><strong>Medicaci칩n Prescrita Di치lisis:</strong> {{ historia.medicacionPrescritaDialisis }}</div>
                      <div *ngIf="historia.medicacionDomiciliaria"><strong>Medicaci칩n Domiciliaria:</strong> {{ historia.medicacionDomiciliaria }}</div>
                      <div *ngIf="historia.detalle"><strong>Detalle:</strong> {{ historia.detalle }}</div>
                    </div>
                  </div>
                </div>
                <div *ngIf="!paciente.historiaClinica || paciente.historiaClinica.length === 0">
                  No hay historia cl칤nica registrada
                </div>
              </div>
            } @else if (seccionActiva === 'dialisis') {
              <div class="seccion-content">
                <h3>Par치metros de Di치lisis</h3>
                <div *ngIf="paciente.parametrosDialisis && objectKeys(paciente.parametrosDialisis).length > 0">
                  <div class="datos-grid">
                    <div *ngFor="let key of objectKeys(paciente.parametrosDialisis)">
                      <strong>{{ key }}:</strong> {{ paciente.parametrosDialisis[key] }}
                    </div>
                  </div>
                </div>
                <div *ngIf="!paciente.parametrosDialisis || objectKeys(paciente.parametrosDialisis).length === 0">
                  No hay par치metros de di치lisis registrados
                </div>
              </div>
            } @else if (seccionActiva === 'evolucion') {
              <div class="seccion-content">
                <h3>Evoluci칩n Mensual</h3>
                <div *ngIf="paciente.evolucionMensual && paciente.evolucionMensual.length > 0">
                  <div *ngFor="let evolucion of paciente.evolucionMensual" style="margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <strong>{{ evolucion.fecha | date:'dd/MM/yyyy' }}:</strong>
                    <div style="margin-left: 20px;">
                      <p><strong>Profesional:</strong> {{ evolucion.profesional }}</p>
                      <p><strong>Informe General:</strong> {{ evolucion.informeGeneral }}</p>
                    </div>
                  </div>
                </div>
                <div *ngIf="!paciente.evolucionMensual || paciente.evolucionMensual.length === 0">
                  No hay evoluci칩n mensual registrada
                </div>
              </div>
            }
          </div>

        </mat-sidenav-content>

      </mat-sidenav-container>
     } @else {
        <div class="no-data">No se encontraron datos para este paciente.</div>
     }
  } @else {
    <div class="loading">Cargando datos del paciente...</div>
  }
</div>
