@if(isLoading) {
  <div style="text-align: center; padding: 20px;">Cargando/Guardando...</div>
}

<form [formGroup]="pacienteForm" (ngSubmit)="onSubmit()">

  @switch (seccionActiva) {

    @case ('datos-personales') {
      <div formGroupName="datosPersonales" class="seccion-content seccion-datos-personales">
        <h3>Datos Personales</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <mat-form-field appearance="outline"> <mat-label>Nombre</mat-label> <input matInput formControlName="nombre" required> @if(datosPersonalesForm.get('nombre')?.invalid && datosPersonalesForm.get('nombre')?.touched){ <mat-error>Nombre requerido</mat-error> } </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Apellido</mat-label> <input matInput formControlName="apellido" required> @if(datosPersonalesForm.get('apellido')?.invalid && datosPersonalesForm.get('apellido')?.touched){ <mat-error>Apellido requerido</mat-error> } </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Fecha de Nacimiento</mat-label> <input matInput [matDatepicker]="pickerNacimiento" formControlName="fechaNacimiento" required readonly> <mat-datepicker-toggle matSuffix [for]="pickerNacimiento"></mat-datepicker-toggle> <mat-datepicker #pickerNacimiento></mat-datepicker> @if(datosPersonalesForm.get('fechaNacimiento')?.invalid && datosPersonalesForm.get('fechaNacimiento')?.touched){ <mat-error>Fecha requerida</mat-error> } </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Documento</mat-label> <input matInput formControlName="documento" required> @if(datosPersonalesForm.get('documento')?.invalid && datosPersonalesForm.get('documento')?.touched){ <mat-error>Documento requerido</mat-error> } </mat-form-field>
          <div> <label id="genero-radio-group-label" style="display: block; margin-bottom: 5px; color: rgba(0,0,0,.6);">Género</label> <mat-radio-group aria-labelledby="genero-radio-group-label" formControlName="genero" required> <mat-radio-button value="Masculino" style="margin-right: 10px;">Masculino</mat-radio-button> <mat-radio-button value="Femenino" style="margin-right: 10px;">Femenino</mat-radio-button> <mat-radio-button value="Otro">Otro</mat-radio-button> </mat-radio-group> @if(datosPersonalesForm.get('genero')?.invalid && datosPersonalesForm.get('genero')?.touched){ <mat-error style="font-size: 75%; color: #f44336;">Género requerido</mat-error> } </div>
          <mat-form-field appearance="outline"> <mat-label>Estado Civil</mat-label> <input matInput formControlName="estadoCivil"> </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Fecha Primera Diálisis</mat-label> <input matInput [matDatepicker]="pickerDialisis" formControlName="fechaPrimeraDialisis" readonly> <mat-datepicker-toggle matSuffix [for]="pickerDialisis"></mat-datepicker-toggle> <mat-datepicker #pickerDialisis></mat-datepicker> </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Teléfonos</mat-label> <input matInput formControlName="telefonos" placeholder="Separados por coma"> </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Domicilio</mat-label> <input matInput formControlName="domicilio"> </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Obra Social</mat-label> <input matInput formControlName="obraSocial"> </mat-form-field>
          <mat-form-field appearance="outline"> <mat-label>Institución</mat-label> <input matInput formControlName="institucion"> </mat-form-field>
          <!-- Campo de Emails Múltiples -->
          <div style="grid-column: 1 / -1;">
            <h4 style="color: #1976d2; margin-bottom: 10px;">Emails Electrónicos</h4>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
              Agregue los emails del paciente. Los primeros serán usados para envío automático de QR.
            </p>
            <div formArrayName="emails">
              @for (emailGroup of emailsArray.controls; track $index) {
                <div [formGroupName]="$index" style="display: flex; align-items: center; margin-bottom: 10px; background-color: #f5f5f5; padding: 10px; border-radius: 4px;">
                  <mat-form-field appearance="outline" style="flex-grow: 1; margin-right: 10px;">
                    <mat-label>Email {{ $index + 1 }}</mat-label>
                    <input matInput type="email" formControlName="email" required>
                    @if (emailGroup.get('email')?.invalid && emailGroup.get('email')?.touched) {
                      <mat-error>Email inválido</mat-error>
                    }
                  </mat-form-field>
                  <button mat-icon-button color="warn" type="button" (click)="eliminarEmail($index)" aria-label="Eliminar email">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              }
              <button mat-stroked-button color="primary" type="button" (click)="agregarEmail()">
                <mat-icon>add</mat-icon> Agregar Email
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    @case ('alergias') {
      <div formGroupName="alergiasTransfusiones" class="seccion-content seccion-alergias">
         <h3>Alergias y Transfusiones</h3>
         <h4>Alergias Conocidas</h4>
         <div formArrayName="alergias">
           @for (alergiaGroup of alergiasArray.controls; track $index) {
             <div [formGroupName]="$index" style="display: flex; align-items: center; margin-bottom: 10px; background-color: #ffebee; padding: 10px; border-radius: 4px;">
               <mat-form-field appearance="outline" style="flex-grow: 1; margin-right: 10px;">
                 <mat-label>Descripción Alergia</mat-label>
                 <input matInput formControlName="descripcion" required style="color: #d32f2f;">
                 @if (alergiaGroup.get('descripcion')?.invalid && alergiaGroup.get('descripcion')?.touched) { <mat-error>Requerido</mat-error> }
               </mat-form-field>
               <button mat-icon-button color="warn" type="button" (click)="eliminarAlergia($index)" aria-label="Eliminar alergia">
                 <mat-icon>delete</mat-icon>
               </button>
             </div>
           }
           <button mat-stroked-button color="primary" type="button" (click)="agregarAlergia()">
             <mat-icon>add</mat-icon> Añadir Alergia
           </button>
         </div>

         <h4 style="margin-top: 20px;">Otros Datos</h4>
         <div style="display: flex; align-items: center; margin-bottom: 10px;">
           <label style="margin-right: 10px; width: 200px;">¿Es Testigo de Jehová?</label>
           <mat-form-field appearance="outline" style="width: 100px;">
             <mat-select formControlName="testigoJehova">
               <mat-option value="true">Sí</mat-option>
               <mat-option value="false">No</mat-option>
             </mat-select>
           </mat-form-field>
         </div>
         <div style="display: flex; align-items: center;">
           <label style="margin-right: 10px; width: 200px;">¿Se transfunde?</label>
           <mat-form-field appearance="outline" style="width: 100px;">
             <mat-select formControlName="seTransfunde">
               <mat-option value="true">Sí</mat-option>
               <mat-option value="false">No</mat-option>
             </mat-select>
           </mat-form-field>
         </div>
      </div>
    }

    @case ('antecedentes') {
        <div formGroupName="antecedentesPersonales" class="seccion-content seccion-antecedentes">
            <h3>Antecedentes Personales</h3>
             <div formArrayName="items">
                @for (antecedenteGroup of antecedentesItems.controls; track $index) {
                    <div [formGroupName]="$index" style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: flex-start; gap: 10px;">
                        <mat-form-field appearance="outline" style="flex: 1;">
                            <mat-label>Antecedente</mat-label>
                            <input matInput formControlName="nombre" required>
                             @if (antecedenteGroup.get('nombre')?.invalid && antecedenteGroup.get('nombre')?.touched) { <mat-error>Requerido</mat-error> }
                        </mat-form-field>
                        <mat-form-field appearance="outline" style="flex: 2;">
                            <mat-label>Detalle</mat-label>
                            <textarea matInput formControlName="detalle" cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5"></textarea>
                        </mat-form-field>
                        <button mat-icon-button color="warn" type="button" (click)="eliminarAntecedente($index)" aria-label="Eliminar antecedente">
                           <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                }
                <button mat-stroked-button color="primary" type="button" (click)="agregarAntecedente()">
                    <mat-icon>add</mat-icon> Añadir Antecedente
                </button>
            </div>
        </div>
    }

    @case ('medicacion') {
      <div formGroupName="medicacionActual" class="seccion-content seccion-medicacion">
        <h3>Medicación Actual</h3>
        <div formArrayName="items">
          @for (medicacionGroup of medicacionItems.controls; track $index) {
            <div [formGroupName]="$index" style="border: 1px solid #d32f2f; padding: 10px; margin-bottom: 10px; border-radius: 4px; background-color: #ffebee;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <mat-form-field appearance="outline">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="nombre" required style="color: #d32f2f;">
                  @if (medicacionGroup.get('nombre')?.invalid && medicacionGroup.get('nombre')?.touched) { <mat-error>Requerido</mat-error> }
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Dosis</mat-label>
                  <input matInput formControlName="dosis" required style="color: #d32f2f;">
                  @if (medicacionGroup.get('dosis')?.invalid && medicacionGroup.get('dosis')?.touched) { <mat-error>Requerido</mat-error> }
                </mat-form-field>
              </div>
              <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button mat-stroked-button color="primary" type="button" (click)="eliminarMedicacion($index)">
                  <mat-icon>delete</mat-icon> Eliminar
                </button>
              </div>
            </div>
          }
          <button mat-stroked-button color="primary" type="button" (click)="agregarMedicacion()">
            <mat-icon>add</mat-icon> Añadir Medicación
          </button>
        </div>
      </div>
    }

    @case ('historia') {
      <div formGroupName="historiaClinica" class="seccion-content seccion-historia">
        <h3>Historia Clínica</h3>
        <div formArrayName="items">
          @for (historiaGroup of historiaItems.controls; track $index) {
            <div [formGroupName]="$index" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #fafafa;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <mat-form-field appearance="outline">
                  <mat-label>Fecha</mat-label>
                  <input matInput formControlName="fecha" type="date" required readonly>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Profesional</mat-label>
                  <input matInput formControlName="profesional" required readonly>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Grupo Sanguíneo</mat-label>
                  <mat-select formControlName="grupoSanguineo" required>
                    <mat-option value="A+">A+</mat-option>
                    <mat-option value="A-">A-</mat-option>
                    <mat-option value="B+">B+</mat-option>
                    <mat-option value="B-">B-</mat-option>
                    <mat-option value="AB+">AB+</mat-option>
                    <mat-option value="AB-">AB-</mat-option>
                    <mat-option value="O+">O+</mat-option>
                    <mat-option value="O-">O-</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Peso (kg)</mat-label>
                  <input matInput formControlName="peso" type="number">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Peso Seco (kg)</mat-label>
                  <input matInput formControlName="pesoSeco" type="number">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Altura (cm)</mat-label>
                  <input matInput formControlName="altura" type="number">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Fecha Primera Diálisis (Vida)</mat-label>
                  <input matInput formControlName="fechaPrimeraDialisisVida" type="date">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Fecha Primera Diálisis (Clínica)</mat-label>
                  <input matInput formControlName="fechaPrimeraDialisisClinica" type="date">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Heparina (dosis)</mat-label>
                  <input matInput formControlName="heparina">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Antecedentes de Enfermedad</mat-label>
                  <textarea matInput formControlName="antecedentesEnfermedad" cdkTextareaAutosize></textarea>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Medicación Prescrita para Diálisis</mat-label>
                  <textarea matInput formControlName="medicacionPrescritaDialisis" cdkTextareaAutosize></textarea>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Medicación Domiciliaria</mat-label>
                  <textarea matInput formControlName="medicacionDomiciliaria" cdkTextareaAutosize></textarea>
                </mat-form-field>
                <mat-form-field appearance="outline" style="grid-column: 1 / -1;">
                  <mat-label>Informe General</mat-label>
                  <textarea matInput formControlName="detalle" cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="3" cdkAutosizeMaxRows="10" required></textarea>
                </mat-form-field>
              </div>
              <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button mat-stroked-button color="primary" type="button" (click)="eliminarHistoria($index)">
                  <mat-icon>delete</mat-icon> Eliminar
                </button>
              </div>
            </div>
          }
          <button mat-stroked-button color="primary" type="button" (click)="agregarHistoria()">
            <mat-icon>add</mat-icon> Añadir Historial
          </button>
        </div>
      </div>
    }

    @case ('dialisis') {
      <div formGroupName="parametrosDialisis" class="seccion-content seccion-dialisis">
        <h3>Parámetros Diálisis</h3>
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">QT</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="qt"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">QD</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="qd"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">QB</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="qb"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">ACCESO VASCULAR</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="accesoVascular"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">AGUJAS</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="agujas"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">HEPARINA</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="heparina"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">FILTRO</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="filtro"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">PESO SECO</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="pesoSeco"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">SODIO</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="sodio"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">BICARBONATO</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="bicarbonato"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">UF</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="uf"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">ERITROPOYETINA</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="eritropoyetina"></mat-form-field>
             </div>
             <div style="display: flex; flex-direction: column; align-items: center;">
               <label style="font-weight: bold; margin-bottom: 5px;">HIERRO</label>
               <mat-form-field appearance="outline" style="width: 100%;"><input matInput formControlName="hierro"></mat-form-field>
             </div>
          </div>

      </div>
    }

    @case ('evolucion') {
      <div formGroupName="evolucionMensual" class="seccion-content seccion-evolucion">
        <h3>Evolución Mensual</h3>
        <div formArrayName="items">
          @for (evolucionGroup of evolucionItems.controls; track $index) {
            <div [formGroupName]="$index" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #fafafa;">
              <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px;">
                <mat-form-field appearance="outline">
                  <mat-label>Fecha</mat-label>
                  <input matInput [matDatepicker]="pickerEvolucion" formControlName="fecha" required readonly>
                  <mat-datepicker-toggle matSuffix [for]="pickerEvolucion"></mat-datepicker-toggle>
                  <mat-datepicker #pickerEvolucion></mat-datepicker>
                  @if (evolucionGroup.get('fecha')?.invalid && evolucionGroup.get('fecha')?.touched) { <mat-error>Requerido</mat-error> }
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Profesional</mat-label>
                  <input matInput formControlName="profesional" required readonly>
                  @if (evolucionGroup.get('profesional')?.invalid && evolucionGroup.get('profesional')?.touched) { <mat-error>Requerido</mat-error> }
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Informe General</mat-label>
                  <textarea matInput formControlName="informeGeneral" cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="3" cdkAutosizeMaxRows="10" required></textarea>
                  @if (evolucionGroup.get('informeGeneral')?.invalid && evolucionGroup.get('informeGeneral')?.touched) { <mat-error>Requerido</mat-error> }
                </mat-form-field>
              </div>
              <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button mat-stroked-button color="primary" type="button" (click)="eliminarEvolucion($index)">
                  <mat-icon>delete</mat-icon> Eliminar
                </button>
              </div>
            </div>
          }
          <button mat-stroked-button color="primary" type="button" (click)="agregarEvolucion()">
            <mat-icon>add</mat-icon> Añadir Evolución
          </button>
        </div>
      </div>
    }


    @default {
      @if (!isLoading && pacienteId) {
         <p>Seleccione una sección del menú lateral para ver o editar.</p>
      } @else if (!isLoading && !pacienteId && seccionActiva !== 'datosPersonales') {
          <p>Error: Intentando mostrar una sección no válida en modo creación.</p>
      }
       }
  } @if (mensajeExito) {
    <p style="color: green; text-align: center; margin-top: 15px;">{{ mensajeExito }}</p>
  }
  @if (mensajeError) {
    <p style="color: red; text-align: center; margin-top: 15px;">{{ mensajeError }}</p>
  }

  @if (seccionActiva || !pacienteId) {
        @if (pacienteForm.get(getFormGroupName(seccionActiva ?? 'datos-personales')!); as currentFormGroup) {
            <button mat-raised-button color="primary" type="submit" [disabled]="currentFormGroup.invalid || isLoading">
               {{ isLoading ? 'Guardando...' : (!pacienteId ? 'Guardar Paciente y Ver Detalle' : 'Guardar Cambios en Sección') }}
            </button>
        }
   }

</form>
